{
  "version": 3,
  "sources": ["../../../../../Modules/Administration/Translation/TranslationPage.ts", "../../../../../Modules/Administration/Translation/TranslationGrid.ts"],
  "sourcesContent": ["import { initFullHeightGridPage } from \"@serenity-is/corelib/q\"\nimport { TranslationGrid } from \"./TranslationGrid\";\n\n$(function() {\n    initFullHeightGridPage(new TranslationGrid($('#GridDiv')).element);\n});", "import { Decorators, EntityGrid, GridUtils, LookupEditor, LookupEditorOptions, ToolButton, Widget } from \"@serenity-is/corelib\";\r\nimport { confirm, isEmptyOrNull, isTrimmedEmpty, notifySuccess, outerHtml, text, trimToEmpty, trimToNull } from \"@serenity-is/corelib/q\";\r\nimport { Column } from \"@serenity-is/sleekgrid\";\r\nimport { TranslationItem, TranslationService } from \"../\";\n\n@Decorators.registerClass()\nexport class TranslationGrid extends EntityGrid<TranslationItem, any> {\n    protected getIdProperty() { return \"Key\"; }\n    protected getLocalTextPrefix() { return \"Administration.Translation\"; }\n    protected getService() { return TranslationService.baseUrl; }\n\n    private hasChanges: boolean;\n    private searchText: string;\n    private sourceLanguage: LookupEditor; \n    private targetLanguage: LookupEditor;\n    private targetLanguageKey: string;\n\n    constructor(container: JQuery) {\n        super(container);\n\n        this.element.on('keyup.' + this.uniqueName + ' change.' + this.uniqueName,\n            'input.custom-text', e =>\n        {\n            var value = trimToNull($(e.target).val());\n            if (value === '') {\n                value = null;\n            }\n            this.view.getItemById($(e.target).data('key')).CustomText = value;\n            this.hasChanges = true;\n        });\n    }\n\n    protected onClick(e: JQueryEventObject, row: number, cell: number): any {\n        super.onClick(e, row, cell);\n\n        if (e.isDefaultPrevented()) {\n            return;\n        }\n\n        let item = this.itemAt(row);\n        let done: () => void;\n\n        if ($(e.target).hasClass('source-text')) {\n            e.preventDefault();\n                \n            done = () => {\n                item.CustomText = item.SourceText;\n                this.view.updateItem(item.Key, item);\n                this.hasChanges = true;\n            };\n\n            if (isTrimmedEmpty(item.CustomText) ||\n                (trimToEmpty(item.CustomText) === trimToEmpty(item.SourceText))) {\n                done();\n                return;\n            }\n\n            confirm(text('Db.Administration.Translation.OverrideConfirmation'), done);\n            return;\n        }\n\n        if ($(e.target).hasClass('target-text')) {\n            e.preventDefault();\n\n            done = () => {\n                item.CustomText = item.TargetText;\n                this.view.updateItem(item.Key, item);\n                this.hasChanges = true;\n            };\n\n            if (isTrimmedEmpty(item.CustomText) ||\n                (trimToEmpty(item.CustomText) === trimToEmpty(item.TargetText))) {\n                done();\n                return;\n            }\n\n            confirm(text('Db.Administration.Translation.OverrideConfirmation'), done);\n            return;\n        }\n    }\n\n    protected getColumns(): Column[] {\n\n        var columns: Column[] = [];\n        columns.push({ field: 'Key', width: 300, sortable: false });\n\n        columns.push({\n            field: 'SourceText',\n            width: 300,\n            sortable: false,\n            format: ctx => {\n                return outerHtml($('<a/>')\n                    .addClass('source-text')\n                    .text(ctx.value || ''));\n            }\n        });\n\n        columns.push({\n            field: 'CustomText',\n            width: 300,\n            sortable: false,\n            format: ctx => outerHtml($('<input/>')\n                .addClass('custom-text')\n                .attr('value', ctx.value)\n                .attr('type', 'text')\n                .attr('data-key', ctx.item.Key))\n        });\n\n        columns.push({\n            field: 'TargetText',\n            width: 300,\n            sortable: false,\n            format: ctx => outerHtml($('<a/>')\n                .addClass('target-text')\n                .text(ctx.value || ''))\n        });\n\n        return columns;\n    }\n\n    protected createToolbarExtensions(): void {\n        super.createToolbarExtensions();\n\n        let opt: LookupEditorOptions = {\n            lookupKey: 'Administration.Language'\n        };\n\n        this.sourceLanguage = Widget.create({\n            type: LookupEditor,\n            element: el => el.appendTo(this.toolbar.element).attr('placeholder', '--- ' +\n                text('Db.Administration.Translation.SourceLanguage') + ' ---'),\n            options: opt\n        });\n\n        this.sourceLanguage.changeSelect2(e => {\n            if (this.hasChanges) {\n                this.saveChanges(this.targetLanguageKey).then(() => this.refresh());\n            }\n            else {\n                this.refresh();\n            }\n        });\n\n        this.targetLanguage = Widget.create({\n            type: LookupEditor,\n            element: el => el.appendTo(this.toolbar.element).attr('placeholder', '--- ' +\n                text('Db.Administration.Translation.TargetLanguage') + ' ---'),\n            options: opt\n        });\n\n        this.targetLanguage.changeSelect2(e => {\n            if (this.hasChanges) {\n                this.saveChanges(this.targetLanguageKey).then(() => this.refresh());\n            }\n            else {\n                this.refresh();\n            }\n        });\n    }\n\n    protected saveChanges(language: string): PromiseLike<any> {\n        var translations: { [key: string]: string } = {};\n        for (let item of this.getItems()) {\n            translations[item.Key] = item.CustomText;\n        }\n\n        return Promise.resolve(TranslationService.Update({\n            TargetLanguageID: language,\n            Translations: translations\n        })).then(() => {\n            this.hasChanges = false;\n            language = trimToNull(language) || 'invariant';\n            notifySuccess('User translations in \"' + language +\n                '\" language are saved to \"user.texts.' +\n                language + '.json\" ' + 'file under \"~/App_Data/texts/\"', '');\n        });\n    }\n\n    protected onViewSubmit(): boolean {\n        var request = this.view.params;\n        request.SourceLanguageID = this.sourceLanguage.value;\n        this.targetLanguageKey = this.targetLanguage.value || '';\n        request.TargetLanguageID = this.targetLanguageKey;\n        this.hasChanges = false;\n        return super.onViewSubmit();\n    }\n    \n    protected getButtons(): ToolButton[] {\n        return [{\n            title: text('Db.Administration.Translation.SaveChangesButton'),\n            onClick: e => this.saveChanges(this.targetLanguageKey).then(() => this.refresh()),\n            cssClass: 'apply-changes-button'\n        }];\n    }\n\n    protected createQuickSearchInput() {\n        GridUtils.addQuickSearchInputCustom(this.toolbar.element,\n            (field, searchText) => {\n                this.searchText = searchText;\n                this.view.setItems(this.view.getItems(), true);\n            });\n    }\n\n    protected onViewFilter(item: TranslationItem) {\n        if (!super.onViewFilter(item)) {\n            return false;\n        }\n\n        if (!this.searchText) {\n            return true;\n        }\n\n        var sd = Select2.util.stripDiacritics;\n        var searching = sd(this.searchText).toLowerCase();\n\n        function match(str: string) {\n            if (!str)\n                return false;\n\n            return str.toLowerCase().indexOf(searching) >= 0;\n        }\n\n        return isEmptyOrNull(searching) || match(item.Key) || match(item.SourceText) ||\n            match(item.TargetText) || match(item.CustomText);\n    }\n\n    protected usePager() {\n        return false;\n    }\n}"],
  "mappings": "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",
  "names": ["import_q", "import_corelib", "import_q", "TranslationGrid", "container", "e", "value", "TranslationService", "row", "cell", "item", "done", "__name", "columns", "ctx", "opt", "el", "language", "translations", "request", "field", "searchText", "sd", "searching", "match", "str", "__decorateClass", "TranslationGrid"]
}
